{% extends "base.html" %}
{% block title %}Simulador de Cr√©dito{% endblock %}

{% block content %}
<section id="inicio" class="p-5 pb-md-5 text-white">
    <div class="col-md-12">
        <h2 class="mb-4 text-center">Simulador de Cr√©dito</h2>
        <p class="text-center mb-5">
            Preencha os campos abaixo para simular a aprova√ß√£o de cr√©dito.
        </p>

        <div class="row justify-content-center">
            <!-- Formul√°rio -->
            <form method="POST" class="border rounded p-4 bg-dark col-md-4 me-md-2 shadow">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Idade</label>
                        <input type="number" step="1" name="person_age" class="form-control"
                               value="{{ dados.person_age if dados else '26' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Score de Cr√©dito (0‚Äì1000)</label>
                        <input type="number" name="credit_score" min="0" max="1000" step="1" class="form-control"
                               value="{{ dados.credit_score if dados else '1000' }}" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Renda Mensal</label>
                        <input type="number" step="100" name="person_income" class="form-control"
                               value="{{ (dados.person_income / 13) if dados else '3000' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Valor do Empr√©stimo</label>
                        <input type="number" step="1000" name="loan_amnt" class="form-control"
                               value="{{ dados.loan_amnt if dados else '20000' }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Finalidade do Empr√©stimo</label>
                    <select name="loan_intent" class="form-select" required>
                        <option value="EDUCATION" {% if dados and dados.loan_intent == 'EDUCATION' %}selected{% endif %}>Educa√ß√£o</option>
                        <option value="MEDICAL" {% if dados and dados.loan_intent == 'MEDICAL' %}selected{% endif %}>Sa√∫de</option>
                        <option value="PERSONAL" {% if dados and dados.loan_intent == 'PERSONAL' %}selected{% endif %}>Pessoal</option>
                        <option value="DEBTCONSOLIDATION" {% if dados and dados.loan_intent == 'DEBTCONSOLIDATION' %}selected{% endif %}>Consolida√ß√£o de D√≠vidas</option>
                        <option value="HOMEIMPROVEMENT" {% if dados and dados.loan_intent == 'HOMEIMPROVEMENT' %}selected{% endif %}>Reforma Residencial</option>
                        <option value="VENTURE" {% if dados and dados.loan_intent == 'VENTURE' %}selected{% endif %}>Empreendimento</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Tipo de Resid√™ncia</label>
                    <select name="person_home_ownership" class="form-select" required>
                        <option value="OWN" {% if dados and dados.person_home_ownership == 'OWN' %}selected{% endif %}>Pr√≥pria</option>
                        <option value="RENT" {% if dados and dados.person_home_ownership == 'RENT' %}selected{% endif %}>Alugada</option>
                        <option value="MORTGAGE" {% if dados and dados.person_home_ownership == 'MORTGAGE' %}selected{% endif %}>Financiada</option>
                        <option value="OTHER" {% if dados and dados.person_home_ownership == 'OTHER' %}selected{% endif %}>Outros</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Possui hist√≥rico de inadimpl√™ncia?</label>
                    <select name="cb_person_default_on_file" class="form-select" required>
                        <option value="N" {% if dados and dados.cb_person_default_on_file == 'N' %}selected{% endif %}>N√£o</option>
                        <option value="Y" {% if dados and dados.cb_person_default_on_file == 'Y' %}selected{% endif %}>Sim</option>
                    </select>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Simular Cr√©dito</button>
                </div>
            </form>
            {% if resultado %}
                <div class="col-md-3 bg-dark border rounded p-4 mt-5 mt-md-0 shadow text-center animate__animated animate__fadeIn
                    {% if not resultado.aprova %}
                        border-danger-custom
                    {% elif resultado.risco_inadimplencia > 0.15 %}
                        border-warning-custom
                    {% else %}
                        border-success-custom
                    {% endif %}
                ">
                    <!-- T√≠tulo com cor din√¢mica -->
                    <h4 class="fw-bold mb-4 titulo-resultado
                        {% if not resultado.aprova %}
                            text-danger-custom
                        {% elif resultado.risco_inadimplencia > 0.15 %}
                            text-warning-custom
                        {% else %}
                            text-success-custom
                        {% endif %}
                    ">
                        {% if not resultado.aprova %}
                            ‚ùå Cr√©dito Negado
                        {% elif resultado.risco_inadimplencia > 0.15 %}
                            ‚ö†Ô∏è Cr√©dito Aprovado com Risco Elevado
                        {% else %}
                            ‚úÖ Cr√©dito Aprovado
                        {% endif %}
                    </h4>

                    <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">

                    <!-- Texto interno branco -->
                    <div class="text-start px-2 text-light">
                        <p><strong>üìâ Risco de inadimpl√™ncia:</strong>
                            <span class="float-end">{{ (resultado.risco_inadimplencia * 100)|round(2) }}%</span>
                        </p>
                        <p><strong>üí∞ Renda anual estimada:</strong>
                            <span class="float-end">R$ {{ "{:,.2f}".format(resultado.renda_anual) }}</span>
                        </p>
                        <p><strong>üìä Score informado:</strong>
                            <span class="float-end">{{ resultado.score }} (Grau: {{ resultado.grade }})</span>
                        </p>
                        <p><strong>üè¶ Taxa de juros aplicada:</strong>
                            <span class="float-end">{{ resultado.taxa_aplicada }}%</span>
                        </p>
                    </div>
                </div>

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
                {% endif %}



            {% if explicacao %}
                <div class="col-md-3 bg-dark border rounded p-4 shadow ms-md-2 mt-5 mt-md-0">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-bar-chart-line-fill text-info me-2"></i>
                        Fatores mais influentes nesta simula√ß√£o
                    </h4>

                    <div>
                        {% for nome, peso in explicacao %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-semibold text-white">{{ nome }}</span>
                                <small class="text-white fw-bold">{{ "%.2f"|format(peso * 100) }}%</small>
                            </div>
                            <div class="progress" style="height: 8px; background-color: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                <div class="progress-bar gradient-bar"
                                     role="progressbar"
                                     style="width: 0%;"
                                     data-width="{{ peso * 100 }}">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <style>
                .gradient-bar {
                    background: linear-gradient(90deg, #00b4d8, #90e0ef, #caf0f8);
                    animation: glow 2s infinite alternate;
                    transition: width 1.5s ease-in-out;
                }
                @keyframes glow {
                    0% { box-shadow: 0 0 5px #00b4d8, 0 0 10px #0077b6; }
                    100% { box-shadow: 0 0 15px #90e0ef, 0 0 30px #00b4d8; }
                }
                </style>

                <script>
                document.addEventListener("DOMContentLoaded", () => {
                    document.querySelectorAll(".gradient-bar").forEach(barra => {
                        const width = barra.getAttribute("data-width");
                        setTimeout(() => {
                            barra.style.width = width + "%";
                        }, 400);
                    });
                });
                </script>
                {% endif %}

        </div>
    </div>
    <div class="container mt-5">
        <div class="row g-4 align-items-center">
        <div class="container bg-dark border rounded p-5 shadow">
            <h2 class="mb-4 text-center">Sobre o Projeto</h2>
            <p class="lead">
                Este projeto √© um simulador interativo de aprova√ß√£o de cr√©dito, desenvolvido como parte do meu portf√≥lio de Data Science e Machine Learning.
                O sistema utiliza um modelo <strong>XGBoost Classifier</strong> treinado para estimar a probabilidade de inadimpl√™ncia com base em informa√ß√µes financeiras e pessoais do solicitante.
            </p>

            <h3 class="mt-4">‚öôÔ∏è Como funciona</h3>
            <p>
                O usu√°rio preenche um formul√°rio com dados como idade, renda, valor do empr√©stimo, finalidade e hist√≥rico de cr√©dito.
                Essas informa√ß√µes passam por um pipeline de pr√©-processamento automatizado, onde s√£o transformadas e padronizadas de acordo com o modelo treinado.
                Em seguida, o modelo faz a previs√£o e o site exibe:
            </p>
            <ul>
                <li>‚úÖ Se o cr√©dito seria aprovado ou negado;</li>
                <li>üìâ A probabilidade estimada de inadimpl√™ncia;</li>
                <li>üí∏ A renda anual estimada;</li>
                <li>üßæ O score informado e o grau de cr√©dito (A‚ÄìG);</li>
                <li>üí∞ A taxa de juros aplicada automaticamente conforme o grau.</li>
            </ul>

            <h3 class="mt-4">üß© Modelagem e Prepara√ß√£o dos Dados</h3>
            <p>
                O modelo foi treinado em dados hist√≥ricos de solicita√ß√µes de cr√©dito contendo vari√°veis demogr√°ficas e financeiras. Durante a prepara√ß√£o dos dados:
            </p>
            <ul>
                <li>üîπ A coluna <code>person_emp_length</code> (tempo de emprego) foi removida por apresentar muitos valores ausentes e baixa relev√¢ncia;</li>
                <li>üîπ A vari√°vel <code>loan_percent_income</code> foi substitu√≠da por <code>loan_to_income_ratio</code>, representando a propor√ß√£o entre o valor solicitado e a renda anual ‚Äî uma m√©trica mais interpret√°vel e est√°vel;</li>
                <li>üîπ Taxas de juros ausentes foram preenchidas automaticamente com a mediana de cada <code>loan_grade</code>;</li>
                <li>üîπ A vari√°vel <code>scale_pos_weight</code> foi ajustada para balancear as classes e melhorar a sensibilidade (recall) para a classe minorit√°ria (inadimplentes).</li>
            </ul>

            <p class="mt-3"><strong>Taxas medianas aplicadas por grau de cr√©dito:</strong></p>
            <ul>
                <li>üÖ∞Ô∏è A: 7.49%</li>
                <li>üÖ±Ô∏è B: 10.99%</li>
                <li>üÖ≤ C: 13.48%</li>
                <li>üÖ≥ D: 15.31%</li>
                <li>üÖ¥ E: 16.82%</li>
                <li>üÖµ F: 18.53%</li>
                <li>üÖ∂ G: 20.11%</li>
            </ul>

            <p class="mt-3">
                Essa abordagem permitiu que o modelo aprendesse a rela√ß√£o natural entre o grau de cr√©dito e a taxa de juros, refletindo melhor o comportamento real do mercado financeiro.
            </p>

            <h3 class="mt-4">ü§ñ Modelo de Machine Learning</h3>
            <p>
                Ap√≥s testar diversos algoritmos supervisionados (<strong>Random Forest</strong>, <strong>Gradient Boosting</strong>, <strong>Logistic Regression</strong>, <strong>SGDClassifier</strong> e <strong>XGBoost</strong>),
                o <strong>XGBoost</strong> foi selecionado como modelo final por apresentar o melhor equil√≠brio entre precis√£o, recall e estabilidade.
            </p>

            <p>Configura√ß√µes principais do modelo:</p>
            <pre class="bg-secondary text-white p-3 rounded"><code>XGBClassifier(
        n_estimators=2000,          # n√∫mero total de √°rvores
        learning_rate=0.08,         # taxa de aprendizado
        max_depth=6,                # profundidade m√°xima das √°rvores
        subsample=0.9,              # amostragem para reduzir overfitting
        colsample_bytree=0.8,       # fra√ß√£o de colunas usadas por √°rvore
        random_state=42,            # reprodutibilidade
        tree_method="hist",         # m√©todo otimizado para CPU
        scale_pos_weight=ratio,     # balanceamento da classe minorit√°ria
        eval_metric="aucpr"         # prioriza precis√£o no recall dos inadimplentes
    )</code></pre>

            <p class="mt-3"><strong>üìä Desempenho do modelo:</strong></p>
            <ul>
                <li>Accuracy: ‚âà 93%</li>
                <li>F1-Score: ~0.82</li>
                <li>AUC (√Årea sob a curva ROC): 0.95</li>
            </ul>

            <p>
                O modelo final foi calibrado e ajustado para uso pr√°tico no simulador, garantindo previs√µes consistentes mesmo com pequenas varia√ß√µes nas entradas.
            </p>

            <h3 class="mt-4">üåê Integra√ß√£o com o Site</h3>
            <p>
                A integra√ß√£o foi feita com <strong>Flask</strong>, utilizando um <strong>Blueprint</strong> dedicado ao simulador de cr√©dito.
                A rota <code>/projetos/simulador-credito</code> carrega o modelo e o pr√©-processador uma √∫nica vez, garantindo desempenho e efici√™ncia.
            </p>

            <p>O fluxo de execu√ß√£o √© simples e direto:</p>
            <ol>
                <li>O usu√°rio preenche o formul√°rio no site.</li>
                <li>Os dados s√£o transformados pelo pr√©-processador salvo (<code>preprocessor_simulador.pkl</code>).</li>
                <li>O modelo (<code>XGBClassifier_simulador.pkl</code>) realiza a previs√£o.</li>
                <li>O resultado √© exibido com aprova√ß√£o, risco de inadimpl√™ncia e informa√ß√µes financeiras complementares.</li>
            </ol>

            <h3 class="mt-4">üé® Interface Visual</h3>
            <p>
                A interface foi constru√≠da com <strong>Bootstrap 5</strong> e <strong>Jinja2</strong>, mantendo uma est√©tica limpa e moderna inspirada em dashboards financeiros.
            </p>

            <ul>
                <li>Formul√°rio centralizado e responsivo;</li>
                <li>Campos persistentes ap√≥s submiss√£o (mant√©m os valores digitados);</li>
                <li>Feedback visual com cores e √≠cones ‚Äî verde (aprovado), vermelho (negado), amarelo (risco elevado);</li>
                <li>Layout adaptado para dispositivos m√≥veis e desktops.</li>
            </ul>

            <h3 class="mt-4">üìÇ Estrutura de Arquivos</h3>
            <pre class="bg-secondary text-white p-3 rounded"><code>ml_models/
    ‚îú‚îÄ‚îÄ model_train_simulador.py          # Script de treino do modelo
    ‚îú‚îÄ‚îÄ model_predict_simulador.py        # Fun√ß√µes de carregamento e predi√ß√£o
    ‚îú‚îÄ‚îÄ preprocessor_simulador.pkl        # Pr√©-processador salvo
    ‚îú‚îÄ‚îÄ feature_columns_simulador.pkl     # Lista das colunas utilizadas
    ‚îú‚îÄ‚îÄ XGBClassifier_simulador.pkl       # Modelo final treinado
    ‚îî‚îÄ‚îÄ taxas_por_grade.pkl               # Tabela de taxas medianas por grau

    templates/
    ‚îî‚îÄ‚îÄ projetos/
        ‚îî‚îÄ‚îÄ simulador-credito.html        # Template da interface do simulador

    views.py                              # Blueprint Flask (rotas)
    app.py                                # Aplica√ß√£o principal Flask
    </code></pre>

            <h3 class="mt-4">üöÄ Tecnologias Utilizadas</h3>
            <ul>
                <li><strong>Python</strong> (pandas, scikit-learn, XGBoost, joblib)</li>
                <li><strong>Flask</strong> (backend e gerenciamento de rotas)</li>
                <li><strong>Bootstrap 5</strong> (interface responsiva)</li>
                <li><strong>HTML + Jinja2</strong> (renderiza√ß√£o din√¢mica)</li>
                <li><strong>Render</strong> (deploy e hospedagem do portf√≥lio)</li>
            </ul>

            <h3 class="mt-4">üìä Demonstra√ß√£o</h3>
            <p>
                O simulador permite testar diferentes cen√°rios de cr√©dito alterando vari√°veis como renda mensal, valor do empr√©stimo e score.
                Os resultados s√£o exibidos de forma intuitiva, como no exemplo:
            </p>

            <pre class="bg-secondary text-white p-3 rounded"><code>‚úÖ Cr√©dito Aprovado
    Risco de inadimpl√™ncia: 9.49%
    Renda anual estimada: R$ 52.000,00
    Score informado: 600 (Grau D)
    Taxa de juros aplicada: 15.31%</code></pre>

            {% if importancias %}
                <div class="mt-5">
                    <h3 class="text-center mb-4">üìà Import√¢ncia das Vari√°veis</h3>
                    <canvas id="chartImportancia" height="450"></canvas>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    const nomesLegiveis = {{ nomes_legiveis|tojson }};
                    const labelsOriginais = {{ importancias.keys()|list|tojson }};
                    const valores = {{ importancias.values()|list|tojson }};
                    const labelsLegiveis = labelsOriginais.map(lbl => nomesLegiveis[lbl] || lbl);

                    const ctx = document.getElementById('chartImportancia').getContext('2d');
                    const chartData = {
                        labels: labelsLegiveis,
                        datasets: [{
                            label: 'Import√¢ncia relativa',
                            data: valores,
                            borderWidth: 1,
                            backgroundColor: 'rgba(0, 200, 255, 0.7)',
                            borderRadius: 6,
                        }]
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { color: '#bde0fe', font: { size: 13 } },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: {
                                    ticks: { color: '#f1faee', font: { size: 13 } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1a1a1a',
                                    titleColor: '#fff',
                                    bodyColor: '#bde0fe'
                                }
                            }
                        }
                    });
                </script>
                {% endif %}
        </div>
    </div>

</section>
{% endblock %}
