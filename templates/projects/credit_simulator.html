{% extends "base.html" %}
{% block title %}Credit Approval Simulator{% endblock %}

{% block content %}
<section id="inicio" class="p-5 pb-md-5 text-white">
    <div class="col-md-12">
        <h2 class="mb-4 text-center">Credit Approval Simulator</h2>
        <p class="text-center mb-5">
            Fill in the fields below to simulate credit approval.
        </p>

        <div class="row justify-content-center">
            <!-- Formul√°rio -->
            <form method="POST" class="border rounded p-4 bg-dark col-md-4 me-md-2 shadow">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Age</label>
                        <input type="number" step="1" name="person_age" class="form-control"
                               value="{{ dados.person_age if dados else '26' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Credit Score (0‚Äì1000)</label>
                        <input type="number" name="credit_score" min="0" max="1000" step="1" class="form-control"
                               value="{{ dados.credit_score if dados else '1000' }}" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Monthly Income</label>
                        <input type="number" step="100" name="person_income" class="form-control"
                               value="{{ (dados.person_income / 13) if dados else '3000' }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Loan Amount</label>
                        <input type="number" step="1000" name="loan_amnt" class="form-control"
                               value="{{ dados.loan_amnt if dados else '20000' }}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label>Loan Purpose</label>
                    <select name="loan_intent" class="form-select" required>
                        <option value="EDUCATION" {% if dados and dados.loan_intent == 'EDUCATION' %}selected{% endif %}>Education</option>
                        <option value="MEDICAL" {% if dados and dados.loan_intent == 'MEDICAL' %}selected{% endif %}>Medical</option>
                        <option value="PERSONAL" {% if dados and dados.loan_intent == 'PERSONAL' %}selected{% endif %}>Personal</option>
                        <option value="DEBTCONSOLIDATION" {% if dados and dados.loan_intent == 'DEBTCONSOLIDATION' %}selected{% endif %}>Debt Consolidation</option>
                        <option value="HOMEIMPROVEMENT" {% if dados and dados.loan_intent == 'HOMEIMPROVEMENT' %}selected{% endif %}>Home Improvement</option>
                        <option value="VENTURE" {% if dados and dados.loan_intent == 'VENTURE' %}selected{% endif %}>Venture</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Home Ownership</label>
                    <select name="person_home_ownership" class="form-select" required>
                        <option value="OWN" {% if dados and dados.person_home_ownership == 'OWN' %}selected{% endif %}>Own</option>
                        <option value="RENT" {% if dados and dados.person_home_ownership == 'RENT' %}selected{% endif %}>Rent</option>
                        <option value="MORTGAGE" {% if dados and dados.person_home_ownership == 'MORTGAGE' %}selected{% endif %}>Mortgage</option>
                        <option value="OTHER" {% if dados and dados.person_home_ownership == 'OTHER' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label>Default History?</label>
                    <select name="cb_person_default_on_file" class="form-select" required>
                        <option value="N" {% if dados and dados.cb_person_default_on_file == 'N' %}selected{% endif %}>No</option>
                        <option value="Y" {% if dados and dados.cb_person_default_on_file == 'Y' %}selected{% endif %}>Yes</option>
                    </select>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">Simulate Credit</button>
                </div>
            </form>
            {% if resultado %}
                <div class="col-md-3 bg-dark border rounded p-4 mt-5 mt-md-0 shadow text-center animate__animated animate__fadeIn
                    {% if not resultado.aprova %}
                        border-danger-custom
                    {% elif resultado.risco_inadimplencia > 0.15 %}
                        border-warning-custom
                    {% else %}
                        border-success-custom
                    {% endif %}
                ">
                    <!-- T√≠tulo com cor din√¢mica -->
                    <h4 class="fw-bold mb-4 titulo-resultado
                        {% if not resultado.aprova %}
                            text-danger-custom
                        {% elif resultado.risco_inadimplencia > 0.15 %}
                            text-warning-custom
                        {% else %}
                            text-success-custom
                        {% endif %}
                    ">
                        {% if not resultado.aprova %}
                            ‚ùå Credit Denied
                        {% elif resultado.risco_inadimplencia > 0.15 %}
                            ‚ö†Ô∏è Approved with High Risk
                        {% else %}
                            ‚úÖ Credit Approved
                        {% endif %}
                    </h4>

                    <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">

                    <!-- Texto interno branco -->
                    <div class="text-start px-2 text-light">
                        <p><strong>üìâ Default Risk:</strong>
                            <span class="float-end">{{ (resultado.risco_inadimplencia * 100)|round(2) }}%</span>
                        </p>
                        <p><strong>üí∞ Estimated Income:</strong>
                            <span class="float-end">R$ {{ "{:,.2f}".format(resultado.renda_anual) }}</span>
                        </p>
                        <p><strong>üìä Provided Score:</strong>
                            <span class="float-end">{{ resultado.score }} (Grade: {{ resultado.grade }})</span>
                        </p>
                        <p><strong>üè¶ Applied Interest Rate:</strong>
                            <span class="float-end">{{ resultado.taxa_aplicada }}%</span>
                        </p>
                    </div>
                </div>

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
                {% endif %}



            {% if explicacao %}
                <div class="col-md-3 bg-dark border rounded p-4 shadow ms-md-2 mt-5 mt-md-0">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-bar-chart-line-fill text-info me-2"></i>
                        Most Influential Factors in this Simulation
                    </h4>

                    <div>
                        {% for nome, peso in explicacao %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-semibold text-white">{{ nome }}</span>
                                <small class="text-white fw-bold">{{ "%.2f"|format(peso * 100) }}%</small>
                            </div>
                            <div class="progress" style="height: 8px; background-color: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                <div class="progress-bar gradient-bar"
                                     role="progressbar"
                                     style="width: 0%;"
                                     data-width="{{ peso * 100 }}">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <style>
                .gradient-bar {
                    background: linear-gradient(90deg, #00b4d8, #90e0ef, #caf0f8);
                    animation: glow 2s infinite alternate;
                    transition: width 1.5s ease-in-out;
                }
                @keyframes glow {
                    0% { box-shadow: 0 0 5px #00b4d8, 0 0 10px #0077b6; }
                    100% { box-shadow: 0 0 15px #90e0ef, 0 0 30px #00b4d8; }
                }
                </style>

                <script>
                document.addEventListener("DOMContentLoaded", () => {
                    document.querySelectorAll(".gradient-bar").forEach(barra => {
                        const width = barra.getAttribute("data-width");
                        setTimeout(() => {
                            barra.style.width = width + "%";
                        }, 400);
                    });
                });
                </script>
                {% endif %}

        </div>
    </div>
    <div class="container mt-5">
        <div class="row g-4 align-items-center">
        <div class="container bg-dark border rounded p-5 shadow">
            <h2 class="mb-4 text-center">About the Project</h2>
            <p class="lead">
                This project is an interactive credit approval simulator developed as part of my Data Science and Machine Learning portfolio.
                The system uses a trained <strong>XGBoost Classifier</strong> model to estimate the probability of default based on financial and personal information of the applicant.
            </p>

            <h3 class="mt-4">‚öôÔ∏è How it works</h3>
            <p>
                The user fills a form with data like age, income, loan amount, purpose and credit history.
                These inputs go through an automated preprocessing pipeline, where they are transformed and standardized according to the trained model.
                Then, the model makes the prediction and the site displays:
            </p>
            <ul>
                <li>‚úÖ Credit Approval Status;</li>
                <li>üìâ Estimated Probability of Default;</li>
                <li>üí∏ Estimated Annual Income;</li>
                <li>üßæ The Credit Score and Grade (A‚ÄìG);</li>
                <li>üí∞ The Interest Rate Applied Automatically Based on the Grade.</li>
            </ul>

            <h3 class="mt-4">üß© Data Modeling and Preparation</h3>
            <p>
                The model was trained on historical credit application 
                data containing demographic and financial variables.<br>
                During data preparation:
            </p>
            <ul>
                <li>The column <code>person_emp_length</code> (employment length) was removed due to high missing values and low relevance;</li>
                <li>The variable <code>loan_percent_income</code> was replaced by <code>loan_to_income_ratio</code>, representing the ratio between the requested amount and annual income ‚Äî a more interpretable and stable metric;</li>
                <li>Missing interest rates were automatically filled with the median of each <code>loan_grade</code>;</li>
                <li>The variable <code>scale_pos_weight</code> was adjusted to balance classes and improve sensitivity (recall) for the minority class (defaults).</li>
            </ul>

            <p class="mt-3"><strong>Median interest rates applied per credit grade:</strong></p>
            <ul>
                <li>A: 7.49%</li>
                <li>B: 10.99%</li>
                <li>C: 13.48%</li>
                <li>D: 15.31%</li>
                <li>E: 16.82%</li>
                <li>F: 18.53%</li>
                <li>G: 20.11%</li>
            </ul>

            <p class="mt-3">
                This approach allowed the model to learn the natural relationship between credit grade and interest rate, reflecting the real behavior of the financial market.
            </p>

            <h3 class="mt-4">ü§ñ Machine Learning Model</h3>
            <p>
                After testing various supervised algorithms (<strong>Random Forest</strong>, <strong>Gradient Boosting</strong>, <strong>Logistic Regression</strong>, <strong>SGDClassifier</strong> and <strong>XGBoost</strong>),
                the <strong>XGBoost Classifier</strong> was selected as the final model due to its best balance between accuracy, recall and stability.
            </p>

            <p>Model main configurations:</p>
            <pre class="bg-secondary text-white p-3 rounded"><code>XGBClassifier(
        n_estimators=2000,          # Total tree count;
        learning_rate=0.08,         # Learning Rate;
        max_depth=6,                # Max depth per tree;
        min_child_weight=1,         # Min sum of instance weight needed in a child;
        subsample=0.9,              # Sampling to reduce overfitting;
        colsample_bytree=0.8,       # Fraction of columns used by each tree;
        random_state=42,            # Reproducibility;
        tree_method="hist",         # Method optimized for CPU;
        scale_pos_weight=ratio,     # Minority class balancing;
        eval_metric="aucpr"         # Prioritize precision in recall of defaults
    )</code></pre>

            <p class="mt-3"><strong>üìä Model Performance:</strong></p>
            <ul>
                <li>Accuracy: ‚âà 93%</li>
                <li>F1-Score: ~0.82</li>
                <li>AUC (Area under ROC curve): 0.95</li>
            </ul>

            <p>
                The final model was calibrated and adjusted for practical use in the simulator, ensuring consistent predictions even with small variations in input data.
            </p>

            <h3 class="mt-4">üåê Integration with the Website</h3>
            <p>
                The integration was done with <strong>Flask</strong>, using a dedicated <strong>Blueprint</strong> for the credit simulator.
                The route <code>/projects/credit_simulator</code> loads the model and the preprocessor once, ensuring performance and efficiency.
            </p>

            <p>The execution flow is simple and direct:</p>
            <ol>
                <li>The user fills out the form on the site.</li>
                <li>The data is transformed by the saved preprocessor (<code>preprocessor_simulador.pkl</code>).</li>
                <li>The model (<code>XGBClassifier_simulador.pkl</code>) performs the prediction.</li>
                <li>The result is displayed with approval, default risk and complementary financial information.</li>
            </ol>

            <h3 class="mt-4">üé® Visual Interface</h3>
            <p>
                The interface was built with <strong>Bootstrap 5</strong> and <strong>Jinja2</strong>, maintaining a clean and modern aesthetic inspired by financial dashboards.
            </p>

            <ul>
                <li>Centered and responsive form;</li>
                <li>Persistent fields after submission (maintains the typed values);</li>
                <li>Visual feedback with colors and icons ‚Äî green (approved), red (denied), yellow (high risk);</li>
                <li>Layout adapted for mobile devices and desktops.</li>
            </ul>

            <h3 class="mt-4">üìÇ Files Structure</h3>
            <pre class="bg-secondary text-white p-3 rounded"><code>ml_models/
    ‚îú‚îÄ‚îÄ model_train_simulador.py          # Model Train Script
    ‚îú‚îÄ‚îÄ model_predict_simulador.py        # Functions for loading and prediction
    ‚îú‚îÄ‚îÄ preprocessor_simulador.pkl        # Saved preprocessor
    ‚îú‚îÄ‚îÄ feature_columns_simulador.pkl     # List of used columns
    ‚îú‚îÄ‚îÄ XGBClassifier_simulador.pkl       # Final trained model
    ‚îî‚îÄ‚îÄ taxas_por_grade.pkl               # Median rates table by grade
    templates/
    ‚îî‚îÄ‚îÄ projects/
        ‚îî‚îÄ‚îÄ credit_simulator.html        # Simulator HTML Template

    views.py                              # Blueprint Flask (routes)
    app.py                                # Main Flask Application
    </code></pre>

            <h3 class="mt-4">üöÄ Technologies Used</h3>
            <ul>
                <li><strong>Python</strong> (pandas, scikit-learn, XGBoost, joblib)</li>
                <li><strong>Flask</strong> (backend and routes management)</li>
                <li><strong>Bootstrap 5</strong> (responsive interface)</li>
                <li><strong>HTML + Jinja2</strong> (dynamic rendering)</li>
                <li><strong>Render</strong> (deployment and hosting of the portfolio)</li>
            </ul>

            <h3 class="mt-4">üìä Demo</h3>
            <p>
                The simulator allows testing different credit scenarios by changing variables such as monthly income, loan amount and score.
                The results are displayed intuitively, as in the example:
            </p>

            <pre class="bg-secondary text-white p-3 rounded"><code>‚úÖ Credit Approved
    Default Risk: 9.49%
    Estimated Annual Income: R$ 52.000,00
    Score Provided: 600 (Grade D)
    Applied Interest Rate: 15.31%</code></pre>

            {% if importancias %}
                <div class="mt-5">
                    <h3 class="text-center mb-4">üìà Import√¢ncia das Vari√°veis</h3>
                    <canvas id="chartImportancia" height="450"></canvas>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    const nomesLegiveis = {{ nomes_legiveis|tojson }};
                    const labelsOriginais = {{ importancias.keys()|list|tojson }};
                    const valores = {{ importancias.values()|list|tojson }};
                    const labelsLegiveis = labelsOriginais.map(lbl => nomesLegiveis[lbl] || lbl);

                    const ctx = document.getElementById('chartImportancia').getContext('2d');
                    const chartData = {
                        labels: labelsLegiveis,
                        datasets: [{
                            label: 'Import√¢ncia relativa',
                            data: valores,
                            borderWidth: 1,
                            backgroundColor: 'rgba(0, 200, 255, 0.7)',
                            borderRadius: 6,
                        }]
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: chartData,
                        options: {
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { color: '#bde0fe', font: { size: 13 } },
                                    grid: { color: 'rgba(255,255,255,0.1)' }
                                },
                                y: {
                                    ticks: { color: '#f1faee', font: { size: 13 } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1a1a1a',
                                    titleColor: '#fff',
                                    bodyColor: '#bde0fe'
                                }
                            }
                        }
                    });
                </script>
                {% endif %}
        </div>
    </div>

</section>
{% endblock %}
